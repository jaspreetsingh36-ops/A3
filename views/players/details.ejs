<%- include('../partials/header') %>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="display-5">Player Profile</h1>
    <div>
        <a href="/players" class="btn btn-secondary">Back to Squad</a>
        <a href="/players/new" class="btn btn-success">Add New Player</a>
    </div>
</div>

<div class="card">
    <!-- Card Header -->
    <div class="card-header bg-primary text-white">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2 class="h4 mb-0">
                    <%= player.name %>
                    <% if (player.jerseyNumber) { %>
                        <small class="fs-6">#<%= player.jerseyNumber %></small>
                    <% } %>
                </h2>
            </div>

            <div class="col-md-4 text-end">
                <span class="badge fs-6 
                    <%= player.role === 'Batsman' ? 'bg-success' : 
                        player.role === 'Bowler' ? 'bg-warning text-dark' : 
                        player.role === 'All-Rounder' ? 'bg-info' : 'bg-secondary' %>">
                    <%= player.role %>
                </span>
            </div>
        </div>
    </div>

    <!-- Card Body -->
    <div class="card-body">

        <!-- Career Overview -->
        <div class="row mb-4">
            <div class="col-12">
                <h4 class="border-bottom pb-2">Career Overview</h4>
            </div>

            <div class="col-md-3 col-6 text-center mb-3">
                <div class="border rounded p-3 bg-light">
                    <h5 class="text-primary"><%= player.matches || 0 %></h5>
                    <small class="text-muted">Matches Played</small>
                </div>
            </div>

            <% if (player.runs && player.runs > 0) { %>
                <div class="col-md-3 col-6 text-center mb-3">
                    <div class="border rounded p-3 bg-light">
                        <h5 class="text-success"><%= player.runs.toLocaleString() %></h5>
                        <small class="text-muted">Runs Scored</small>
                    </div>
                </div>
            <% } %>

            <% if (player.wickets && player.wickets > 0) { %>
                <div class="col-md-3 col-6 text-center mb-3">
                    <div class="border rounded p-3 bg-light">
                        <h5 class="text-danger"><%= player.wickets %></h5>
                        <small class="text-muted">Wickets Taken</small>
                    </div>
                </div>
            <% } %>

            <% if (player.average && player.average > 0) { %>
                <div class="col-md-3 col-6 text-center mb-3">
                    <div class="border rounded p-3 bg-light">
                        <h5 class="text-info"><%= player.average %></h5>
                        <small class="text-muted">Batting Average</small>
                    </div>
                </div>
            <% } %>
        </div>

        <!-- Detailed Stats -->
        <div class="row">

            <!-- Batting Stats -->
            <div class="col-md-6">
                <h5 class="mb-3">Batting Statistics</h5>
                <table class="table table-sm">
                    <tbody>
                        <tr>
                            <td><strong>Runs per Match:</strong></td>
                            <td>
                                <%= player.matches > 0 ? (player.runs / player.matches).toFixed(2) : "0.00" %>
                            </td>
                        </tr>

                        <% if (player.strikeRate && player.strikeRate > 0) { %>
                            <tr>
                                <td><strong>Strike Rate:</strong></td>
                                <td><%= player.strikeRate %></td>
                            </tr>
                        <% } %>

                        <% if (player.average && player.average > 0) { %>
                            <tr>
                                <td><strong>Batting Average:</strong></td>
                                <td><%= player.average %></td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>

            <!-- Bowling Stats -->
            <div class="col-md-6">
                <h5 class="mb-3">Bowling Statistics</h5>
                <table class="table table-sm">
                    <tbody>
                        <% if (player.wickets && player.wickets > 0) { %>
                            <tr>
                                <td><strong>Wickets per Match:</strong></td>
                                <td>
                                    <%= player.matches > 0 ? (player.wickets / player.matches).toFixed(2) : "0.00" %>
                                </td>
                            </tr>
                        <% } %>

                        <tr>
                            <td><strong>Primary Role:</strong></td>
                            <td><%= player.role %></td>
                        </tr>

                        <% if (player.jerseyNumber) { %>
                            <tr>
                                <td><strong>Jersey Number:</strong></td>
                                <td>#<%= player.jerseyNumber %></td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Performance Bars -->
        <div class="row mt-4">
            <div class="col-12">
                <h5 class="mb-3">Performance Analysis</h5>

                <!-- FIX 1: Added proper percentage calculation for batting -->
                <div class="progress mb-2" style="height: 25px;">
                    <div class="progress-bar bg-success" 
                        style="width: <%= Math.min(((player.runs || 0) / 10000) * 100, 100) %>%">
                        Batting: <%= (player.runs || 0).toLocaleString() %> runs
                    </div>
                </div>

                <!-- FIX 2: Added proper percentage calculation for bowling -->
                <div class="progress" style="height: 25px;">
                    <div class="progress-bar bg-warning"
                        style="width: <%= Math.min(((player.wickets || 0) / 500) * 100, 100) %>%">
                        Bowling: <%= player.wickets || 0 %> wickets
                    </div>
                </div>

            </div>
        </div>

    </div>

    <!-- Footer -->
    <div class="card-footer">
        <div class="d-flex gap-2">
            <a href="/players/<%= player._id %>/edit" class="btn btn-warning">Edit Player Stats</a>
            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                Remove from Team
            </button>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Confirm Player Removal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <p>Are you sure you want to remove <strong><%= player.name %></strong> from the team?</p>
                <div class="alert alert-warning">
                    <strong>Warning:</strong> This will permanently delete all statistics for this player.
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>

                <form action="/players/<%= player._id %>/delete" method="POST">
                    <button class="btn btn-danger">Yes, Remove Player</button>
                </form>
            </div>

        </div>
    </div>
</div>

<%- include('../partials/footer') %>
